apiVersion: v1
kind: ConfigMap
metadata:
  name: gha-runner-scale-set-values-base
  namespace: gha-runner-scale-set
data:
  values.yaml: |
    githubConfigUrl: "https://github.com/power-Igor/test-java-runner"
    githubConfigSecret: "gha-github-pat"

    runnerScaleSetName: "arc-java"
    minRunners: 1
    maxRunners: 2

    controllerServiceAccount:
      name: gha-runner-scale-set-controller-sa
      namespace: gha-runner-scale-set-controller

    # Docker-in-Docker mode (chart will inject dind sidecar)
    containerMode:
      type: dind

    # All pod customizations must live under template.spec
    template:
      spec:
        imagePullSecrets:
          - name: docker-hub-cred

        # Allow scheduling on a tainted control-plane node (if that's your only node)
        tolerations:
          - key: "node-role.kubernetes.io/control-plane"
            operator: "Exists"
            effect: "NoSchedule"
          - key: "node-role.kubernetes.io/master"
            operator: "Exists"
            effect: "NoSchedule"

        # ----- begin injected DinD block (only runner image changed) -----
        initContainers:
          - name: init-dind-externals
            image: ghcr.io/actions/actions-runner:2.319.1
            command: ["cp", "-r", "/home/runner/externals/.", "/home/runner/tmpDir/"]
            volumeMounts:
              - name: dind-externals
                mountPath: /home/runner/tmpDir

        containers:
          # DinD sidecar (privileged)
          - name: dind
            image: docker:dind
            args:
              - dockerd
              - --host=unix:///var/run/docker.sock
              - --group=$(DOCKER_GROUP_GID)
            env:
              - name: DOCKER_GROUP_GID
                value: "123"
            securityContext:
              privileged: true
            startupProbe:
              exec:
                command: ["docker", "info"]
              initialDelaySeconds: 0
              failureThreshold: 24
              periodSeconds: 5
            volumeMounts:
              - name: work
                mountPath: /home/runner/_work
              - name: dind-sock
                mountPath: /var/run
              - name: dind-externals
                mountPath: /home/runner/externals

          # Runner container (custom image here)
          - name: runner
            image: docker.io/19901/runner-java:1.0.1   # must include /home/runner/run.sh (ideally built FROM ghcr.io/actions/actions-runner)
            command: ["/home/runner/run.sh"]
            env:
              - name: DOCKER_HOST
                value: unix:///var/run/docker.sock
              - name: RUNNER_WAIT_FOR_DOCKER_IN_SECONDS
                value: "120"
              - name: RUNNER_LABELS
                value: "arc,java"
              # Optional: turn on verbose runner logs
              # - name: ACTIONS_RUNNER_DEBUG
              #   value: "true"
            resources:
              requests:
                cpu: "200m"
                memory: "256Mi"
              limits:
                cpu: "1"
                memory: "1Gi"
            volumeMounts:
              - name: work
                mountPath: /home/runner/_work
              - name: dind-sock
                mountPath: /var/run

        volumes:
          - name: work
            emptyDir: {}
          - name: dind-sock
            emptyDir: {}
          - name: dind-externals
            emptyDir: {}
        # ----- end injected DinD block -----
